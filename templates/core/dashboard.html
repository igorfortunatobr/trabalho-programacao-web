{% extends 'base.html' %}

{% block title %}Dashboard - Controle Financeiro{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Dashboard - {{ month_name|title }} de {{ year }}</h2>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
            <div class="card-header">Receitas</div>
            <div class="card-body">
                <h5 class="card-title">R$ {{ summary.income|floatformat:2 }}</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3">
            <div class="card-header">Despesas</div>
            <div class="card-body">
                <h5 class="card-title">R$ {{ summary.expense|floatformat:2 }}</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white {% if summary.balance >= 0 %}bg-primary{% else %}bg-warning{% endif %} mb-3">
            <div class="card-header">Saldo</div>
            <div class="card-body">
                <h5 class="card-title">R$ {{ summary.balance|floatformat:2 }}</h5>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Totais por Categoria</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Saldo Acumulado Diário</h5>
            </div>
            <div class="card-body">
                <canvas id="dailyBalanceChart"></canvas>
            </div>
        </div>
    </div>
</div>

{{ category_totals|json_script:"category-data" }}
{{ daily_balance|json_script:"daily-data" }}

<script>
document.addEventListener('DOMContentLoaded', () => {
  const catEl = document.getElementById("category-data");
  const dayEl = document.getElementById("daily-data");
  if (!catEl || !dayEl) return;

  const categoryData = JSON.parse(catEl.textContent || "{}");
  const dailyData = JSON.parse(dayEl.textContent || "[]");

  const categoryLabels = Object.keys(categoryData);
  const categoryValues = Object.values(categoryData);

  // Ordena por data (se já não vier ordenado)
  dailyData.sort((a, b) => a.date.localeCompare(b.date));
  const dailyDates = dailyData.map(i => i.date);
  const dailyBalances = dailyData.map(i => i.balance);

  // Cores dinâmicas suficientes p/ qualquer nº de categorias
  const palette = [
    'rgba(255,99,132,0.2)','rgba(54,162,235,0.2)','rgba(255,205,86,0.2)',
    'rgba(75,192,192,0.2)','rgba(153,102,255,0.2)','rgba(255,159,64,0.2)'
  ];
  const paletteBorder = [
    'rgb(255,99,132)','rgb(54,162,235)','rgb(255,205,86)',
    'rgb(75,192,192)','rgb(153,102,255)','rgb(255,159,64)'
  ];
  const bg = categoryLabels.map((_, i) => palette[i % palette.length]);
  const bd = categoryLabels.map((_, i) => paletteBorder[i % paletteBorder.length]);

  // Category Chart
  const catCanvas = document.getElementById('categoryChart');
  if (catCanvas) {
    const ctx = catCanvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: categoryLabels,
        datasets: [{
          label: 'Valor',
          data: categoryValues,
          backgroundColor: bg,
          borderColor: bd,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => (ctx.parsed.y)
                .toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
            }
          }
        }
      }
    });
  }

  // Daily Balance Chart
  const dailyCanvas = document.getElementById('dailyBalanceChart');
  if (dailyCanvas) {
    const ctx2 = dailyCanvas.getContext('2d');
    new Chart(ctx2, {
      type: 'line',
      data: {
        labels: dailyDates,
        datasets: [{
          label: 'Saldo Acumulado',
          data: dailyBalances,
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) }
          }
        }
      }
    });
  }
});
</script>
{% endblock %}